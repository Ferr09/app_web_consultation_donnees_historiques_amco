<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>AMCO – Résultats de la requête avancée</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script>
        const STATIC_URL = "{{ url_for('static', filename='') }}";
    </script>
</head>

<body data-user-id="{{ current_user.id }}" data-page="resultats-avances">
    <div class="fond-ext">
        <div class="superposition">
            <div id="conteneur-notifications" class="conteneur-notifications"></div>
            <div class="container">
                <!-- Barre latérale (inchangée) -->
                <nav class="sidebar">
                    <ul class="nav-items">
                        <li><img src="{{ url_for('static', filename='images/logo-groupe-amco.png') }}" alt="Logo"
                                width="90"></li>
                        <li><a href="{{ url_for('main.filtre_requete') }}" title="Requête simple"><i
                                    class="fas fa-search"></i><span>Requête simple</span></a></li>
                        <li class="active"><a href="{{ url_for('main.filtre_requete_avancee') }}"
                                title="Requête avancée"><i class="fas fa-chart-line"></i><span>Requête
                                    avancée</span></a></li>
                        <li><a href="{{ url_for('main.documentation') }}" title="Documentation"><i
                                    class="fas fa-file-alt"></i><span>Documentation</span></a></li>
                        <li>
                            <a href="{{ url_for('main.profil') }}" title="Mon Profil">
                                <i class="fas fa-user"></i>
                                <span>Mon Profil</span>
                            </a>
                        </li>
                        {% if current_user.is_authenticated and current_user.is_admin() %}
                        <li><a href="{{ url_for('admin.panel_admin') }}" title="Administration"><i
                                    class="fas fa-cog"></i><span>Administration</span></a></li>
                        {% endif %}
                    </ul>
                    <div class="logout">
                        <a href="{{ url_for('auth.logout') }}" title="Sortir"><i
                                class="fas fa-sign-out-alt"></i><span>Sortir</span></a>
                    </div>
                </nav>

                <!-- Contenu principal (inchangé) -->
                <main class="content">
                    <div class="results-header">
                        <a href="{{ url_for('main.filtre_requete_avancee') }}" class="btn-back" aria-label="Retour">
                            <img src="{{ url_for('static', filename='images/left-arrow.png') }}" alt="Retour" width="30"
                                height="30">
                        </a>
                        <h1>Résultats de la requête</h1>
                        <div id="result-count"></div>
                    </div>

                    <div class="download-bar">
                        <button class="download-main" id="btn-download">Télécharger</button>
                        <div class="download-options toggle-group">
                            <label>
                                <input type="radio" name="download_format" value="csv" checked>
                                <span>CSV</span>
                            </label>
                            <label>
                                <input type="radio" name="download_format" value="xlsx">
                                <span>XLSX</span>
                            </label>
                        </div>
                    </div>

                    <div class="carte">
                        <div class="carte-corps">
                            <div class="conteneur-defilement">
                                <table class="table-donnees">
                                    <thead>
                                        <tr id="tableau-en-tete">
                                            {% for col in colonnes %}
                                            <th>{{ col.replace('_', ' ').title() }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody id="tableau-corps">
                                        {% if donnees %}
                                        {% for ligne in donnees %}
                                        <tr>
                                            {% for col in colonnes %}
                                            <td>{{ ligne[col] }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="{{ colonnes|length or 1 }}" class="no-results"
                                                style="text-align: center; padding: 20px;">
                                                Aucun résultat trouvé pour les filtres sélectionnés.
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="pagination">
                        <button id="prev-page" disabled>←</button>
                        <span class="page-indicator" id="page-number">1 / 1</span>
                        <button id="next-page" disabled>→</button>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Script pour la fonctionnalité (MODIFIÉ) -->
    <script>
        const allData = {{ donnees | tojson }};
        const allColumns = {{ colonnes | tojson }};
        const filtres = {{ filtres | tojson }};
        const nom_fonction = "{{ nom_fonction }}";

        document.addEventListener('DOMContentLoaded', function () {
            const pageSize = 15;
            let currentPage = 1;
            let totalPages = Math.ceil(allData.length / pageSize) || 1;
            let totalData = allData.length;

            const tableBody = document.getElementById('tableau-corps');
            const pageNumSpan = document.getElementById('page-number');
            const btnPrev = document.getElementById('prev-page');
            const btnNext = document.getElementById('next-page');
            const btnDownload = document.getElementById('btn-download');

            // ========================================================================
            // ==== NOUVEAU : Logique de formatage des nombres ========================
            // ========================================================================

            // 1. Liste des mots-clés pour identifier les colonnes de prix/montants
            const colonnesPrixKeywords = ['prix', 'montant', 'total', 'ht', 'ttc', 'valeur', 'cost'];

            // 2. Fonction pour formater un nombre
            function formaterNombre(valeur) {
                // Si la valeur n'est pas un nombre ou est nulle, on ne la touche pas
                if (typeof valeur !== 'number' || valeur === null) {
                    return valeur !== null ? valeur : ''; // Retourne une chaîne vide pour les valeurs nulles
                }
                
                // Utilise toLocaleString('fr-FR') qui met un espace comme séparateur de milliers
                // et une virgule pour les décimales. On force 2 chiffres après la virgule.
                // Exemple: 12345.67 -> "12 345,67"
                return valeur.toLocaleString('fr-FR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }


            // ========================================================================
            // ==== MODIFIÉ : La fonction renderTable utilise maintenant le formatage ==
            // ========================================================================
            function renderTable() {
                tableBody.innerHTML = ''; // Vide la table
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageData = allData.slice(start, end);

                if (pageData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="${allColumns.length || 1}" class="no-results" style="text-align: center; padding: 20px;">
                                Aucun résultat trouvé pour les filtres sélectionnés.
                            </td>
                        </tr>`;
                    return;
                }

                pageData.forEach(ligne => {
                    const tr = document.createElement('tr');
                    let cells = '';
                    allColumns.forEach(col => {
                        let valeurCellule = ligne[col]; // On prend la valeur originale
                        const nomColonneMinuscule = col.toLowerCase();

                        // On vérifie si le nom de la colonne contient un de nos mots-clés
                        const estColonnePrix = colonnesPrixKeywords.some(keyword => nomColonneMinuscule.includes(keyword));

                        // Si c'est une colonne de prix, on formate la valeur
                        if (estColonnePrix) {
                            valeurCellule = formaterNombre(ligne[col]);
                        }

                        // On s'assure que les valeurs nulles deviennent des chaînes vides
                        const contenuFinal = valeurCellule !== null ? valeurCellule : '';
                        cells += `<td>${contenuFinal}</td>`;
                    });
                    tr.innerHTML = cells;
                    tableBody.appendChild(tr);
                });
            }

            // Le reste des fonctions reste inchangé
            function updatePagination() {
                pageNumSpan.textContent = `${currentPage} / ${totalPages}`;
                btnPrev.disabled = currentPage === 1;
                btnNext.disabled = currentPage >= totalPages;
            }

            function updateResultCount() {
                const countElement = document.getElementById('result-count');
                if (!countElement) return;
                const totalResults = allData.length;
                if (totalResults > 0) {
                    countElement.innerHTML = `<h3>${totalResults} résultat${totalResults > 1 ? 's' : ''}</h3>`;
                } else {
                    countElement.innerHTML = '<h3>Aucun résultat</h3>';
                }
            }

            btnPrev.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    updatePagination();
                }
            });

            btnNext.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    updatePagination();
                }
            });

            if (btnDownload) {
                btnDownload.addEventListener('click', async () => {
                    const format = document.querySelector('input[name="download_format"]:checked').value;
                    const originalText = btnDownload.textContent;
                    btnDownload.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btnDownload.disabled = true;

                    try {
                        const response = await fetch('/api/requete-avancee/download', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ format, nom_fonction, filtres })
                        });
                        if (!response.ok) throw new Error('Erreur du serveur.');
                        const blob = await response.blob();
                        const contentDisposition = response.headers.get('Content-Disposition');
                        let filename = `export_avancee.${format}`;
                        if (contentDisposition) {
                            const match = contentDisposition.match(/filename="?(.+)"?/i);
                            if (match) filename = match[1];
                        }
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                    } catch (error) {
                        console.error('Erreur:', error);
                        alert(error.message);
                    } finally {
                        btnDownload.textContent = originalText;
                        btnDownload.disabled = false;
                    }
                });
            }

            renderTable();
            updatePagination();
            updateResultCount();
        });
    </script>

</body>

</html>